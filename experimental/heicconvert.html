<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HEIC to JPG Converter</title>
  <script src="./heic2any.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { text-align: center; color: #333; margin-bottom: 10px; font-size: 32px; }
    .subtitle { text-align: center; color: #666; margin-bottom: 30px; }
    .upload-area {
      border: 3px dashed #667eea; border-radius: 15px;
      padding: 60px 20px; text-align: center;
      cursor: pointer; transition: all 0.3s; margin-bottom: 30px;
    }
    .upload-area:hover { border-color: #764ba2; background: #f8f9ff; }
    .upload-area.dragover { background: #f0f2ff; border-color: #764ba2; }
    .upload-icon { font-size: 48px; margin-bottom: 15px; }
    #fileInput { display: none; }
    .file-list { margin-top: 20px; }
    .file-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 10px;
    }
    .file-info { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
    .file-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .status { padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: 600; margin-right: 10px; }
    .status.pending { background: #ffeaa7; color: #d63031; }
    .status.converting { background: #74b9ff; color: #0984e3; }
    .status.complete { background: #55efc4; color: #00b894; }
    .status.error { background: #ff7675; color: #d63031; }
    button {
      padding: 12px 24px; border: none; border-radius: 8px;
      font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;
    }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover:not(:disabled) { background: #5568d3; transform: translateY(-2px); }
    .btn-success { background: #00b894; color: white; }
    .btn-success:hover { background: #019874; }
    .btn-danger { background: #ff7675; color: white; padding: 8px 12px; }
    .btn-danger:hover { background: #d63031; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .controls { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
    .progress-bar {
      width: 100%; height: 8px; background: #e0e0e0;
      border-radius: 10px; overflow: hidden; margin: 20px 0;
    }
    .progress-fill {
      height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%; transition: width 0.3s;
    }
    .actions { display: flex; gap: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üñºÔ∏è HEIC to JPG Converter</h1>
    <p class="subtitle">Convert HEIC images to JPG ‚Äî fully offline, right in your browser.</p>

    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">üì§</div>
      <p style="font-size:18px;margin-bottom:5px;">Click to upload or drag and drop</p>
      <p style="color:#999;font-size:14px;">HEIC and HEIF files only</p>
    </div>

    <input type="file" id="fileInput" multiple accept=".heic,.HEIC,.heif,.HEIF,image/heic,image/HEIC,image/heif,image/HEIF" />

    <div id="progressContainer" style="display:none;">
      <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
    </div>

    <div class="controls" id="controls" style="display:none;">
      <button class="btn-primary" id="convertBtn">Convert All</button>
      <button class="btn-success" id="downloadBtn" style="display:none;">Download All</button>
    </div>

    <div class="file-list" id="fileList"></div>
  </div>

  <script>
    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");
    const convertBtn = document.getElementById("convertBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const controls = document.getElementById("controls");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");

    let files = [];

    uploadArea.addEventListener("click", () => fileInput.click());
    uploadArea.addEventListener("dragover", e => {
      e.preventDefault();
      uploadArea.classList.add("dragover");
    });
    uploadArea.addEventListener("dragleave", () => uploadArea.classList.remove("dragover"));
    uploadArea.addEventListener("drop", e => {
      e.preventDefault();
      uploadArea.classList.remove("dragover");
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener("change", e => handleFiles(e.target.files));

    function handleFiles(newFiles) {
      const heicFiles = Array.from(newFiles).filter(f =>
        f.name.toLowerCase().endsWith(".heic") ||
        f.name.toLowerCase().endsWith(".heif") ||
        f.type === "image/heic" ||
        f.type === "image/heif"
      );
      heicFiles.forEach(file => {
        files.push({ file, name: file.name, status: "pending", blob: null });
      });
      renderFileList();
      controls.style.display = "flex";
    }

    function renderFileList() {
      fileList.innerHTML = "";
      files.forEach((fileObj, index) => {
        const fileItem = document.createElement("div");
        fileItem.className = "file-item";
        fileItem.innerHTML = `
          <div class="file-info">
            <span>üìÑ</span>
            <span class="file-name">${fileObj.name}</span>
          </div>
          <div class="actions">
            <span class="status ${fileObj.status}">${getStatusText(fileObj.status)}</span>
            ${fileObj.status === "complete" ? `<button class="btn-success" onclick="downloadFile(${index})">Download</button>` : ""}
            <button class="btn-danger" onclick="removeFile(${index})">‚úï</button>
          </div>`;
        fileList.appendChild(fileItem);
      });
    }

    function getStatusText(status) {
      const texts = {
        pending: "Pending",
        converting: "Converting...",
        complete: "Complete",
        error: "Failed"
      };
      return texts[status] || status;
    }

    window.removeFile = function (index) {
      files.splice(index, 1);
      renderFileList();
      if (files.length === 0) controls.style.display = "none";
    };

    window.downloadFile = async function (index) {
      const fileObj = files[index];
      if (!fileObj.blob) return;
      const url = URL.createObjectURL(fileObj.blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileObj.name.replace(/\.(heic|heif)$/i, ".jpg");
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    convertBtn.addEventListener("click", async () => {
      convertBtn.disabled = true;
      progressContainer.style.display = "block";
      for (let i = 0; i < files.length; i++) {
        if (files[i].status === "complete") continue;
        files[i].status = "converting";
        renderFileList();
        try {
          const jpegBlob = await heic2any({
            blob: files[i].file,
            toType: "image/jpeg",
            quality: 0.95,
            wasmPath: "./heic2any.wasm" // explicit path to WASM
          });
          files[i].blob = jpegBlob;
          files[i].status = "complete";
        } catch (error) {
          console.error("Conversion error:", error);
          files[i].status = "error";
        }
        renderFileList();
        progressBar.style.width = ((i + 1) / files.length * 100) + "%";
        await new Promise(r => setTimeout(r, 10)); // throttle loop
      }
      convertBtn.disabled = false;
      downloadBtn.style.display = "inline-block";
    });

    downloadBtn.addEventListener("click", () => {
      files.forEach((f, i) => {
        if (f.status === "complete") setTimeout(() => downloadFile(i), i * 150);
      });
    });
  </script>
</body>
</html>
