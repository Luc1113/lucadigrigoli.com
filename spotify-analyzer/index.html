<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Data Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e1e1e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #1db954, #1ed760);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.2em;
            color: #b3b3b3;
        }

        .help-link {
            display: inline-block;
            margin-top: 15px;
            color: #1db954;
            text-decoration: none;
            font-size: 0.95em;
            padding: 8px 16px;
            border: 1px solid rgba(29, 185, 84, 0.3);
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .help-link:hover {
            background: rgba(29, 185, 84, 0.1);
            border-color: rgba(29, 185, 84, 0.6);
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            border: 2px dashed rgba(29, 185, 84, 0.3);
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: rgba(29, 185, 84, 0.6);
            background: rgba(255, 255, 255, 0.08);
        }

        .spotify-connect-section {
            background: rgba(30, 215, 96, 0.1);
            border: 2px solid rgba(30, 215, 96, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .spotify-connect-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1ed760;
        }

        .spotify-connect-description {
            color: #b3b3b3;
            margin-bottom: 20px;
            font-size: 0.95em;
        }

        .time-range-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .time-range-btn {
            background: linear-gradient(135deg, #1db954, #1ed760);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-range-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(29, 185, 84, 0.4);
        }

        .time-range-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .spotify-note {
            font-size: 0.85em;
            color: #888;
            font-style: italic;
        }

        .divider {
            text-align: center;
            color: #666;
            margin: 30px 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 0.9em;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #1db954, #1ed760);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .upload-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(29, 185, 84, 0.4);
        }

        .file-info {
            margin-top: 20px;
            color: #1db954;
            font-size: 0.95em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(29, 185, 84, 0.5);
        }

        .stat-label {
            font-size: 0.9em;
            color: #b3b3b3;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #1db954;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #1db954;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-label {
            font-size: 0.9em;
            color: #b3b3b3;
        }

        select, input[type="text"] {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 0.95em;
            outline: none;
            transition: all 0.3s ease;
        }

        select:hover, input[type="text"]:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        select:focus, input[type="text"]:focus {
            border-color: #1db954;
        }

        option {
            background: #1e1e1e;
            color: white;
        }

        .exclude-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .exclude-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .excluded-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .excluded-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            color: #ef4444;
        }

        .excluded-tag button {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1;
            padding: 0;
            margin: 0;
            transition: all 0.2s ease;
        }

        .excluded-tag button:hover {
            transform: scale(1.2);
        }

        .top-list {
            list-style: none;
        }

        .top-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .top-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .rank {
            font-size: 1.5em;
            font-weight: 700;
            color: #1db954;
            min-width: 40px;
        }

        .item-info {
            flex: 1;
            margin: 0 20px;
        }

        .item-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .item-detail {
            font-size: 0.9em;
            color: #b3b3b3;
        }

        .item-stat {
            text-align: right;
            color: #1db954;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .artist-link {
            color: #1db954;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: underline;
            text-decoration-color: transparent;
        }

        .artist-link:hover {
            color: #1ed760;
            text-decoration-color: #1ed760;
        }

        .timeline-item {
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-left: 4px solid #1db954;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .timeline-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-left-width: 6px;
        }

        .timeline-date {
            font-size: 0.9em;
            color: #1db954;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .timeline-artist {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .timeline-track {
            font-size: 0.9em;
            color: #b3b3b3;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #1db954;
        }

        .hidden {
            display: none;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95em;
            font-weight: 500;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #1db954, #1ed760);
            border-color: #1db954;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .load-more-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(29, 185, 84, 0.3);
            border-radius: 10px;
            color: #1db954;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .load-more-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(29, 185, 84, 0.6);
            transform: translateY(-2px);
        }

        .share-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin: 10px 5px;
        }

        .share-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        /* Story Card Styles */
        .story-card {
            width: 1080px;
            height: 1920px;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e1e1e 100%);
            position: relative;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            padding: 80px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .story-header {
            text-align: center;
        }

        .story-title {
            font-size: 120px;
            font-weight: 700;
            background: linear-gradient(90deg, #1db954, #1ed760);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 40px;
        }

        .story-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 60px;
        }

        .story-stat {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 60px;
            border: 2px solid rgba(29, 185, 84, 0.3);
            text-align: center;
        }

        .story-stat-label {
            font-size: 48px;
            color: #b3b3b3;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 4px;
        }

        .story-stat-value {
            font-size: 140px;
            font-weight: 700;
            color: #1db954;
            line-height: 1;
        }

        .story-list-item {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 50px 60px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 40px;
        }

        .story-rank {
            font-size: 100px;
            font-weight: 700;
            color: #1db954;
            min-width: 140px;
        }

        .story-item-info {
            flex: 1;
        }

        .story-item-name {
            font-size: 64px;
            font-weight: 600;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .story-item-detail {
            font-size: 48px;
            color: #b3b3b3;
        }

        .story-footer {
            text-align: center;
            padding-top: 40px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        .story-url {
            font-size: 44px;
            color: #1db954;
            font-weight: 600;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            overflow: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            position: relative;
            margin: 2% auto;
            width: 90%;
            max-width: 600px;
        }

        .modal-close {
            position: absolute;
            right: 20px;
            top: 20px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            background: rgba(0, 0, 0, 0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .modal-actions {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            margin-top: 20px;
        }

        .download-btn {
            background: linear-gradient(135deg, #1db954, #1ed760);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .download-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(29, 185, 84, 0.4);
        }

        .info-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-title {
            font-size: 1.8em;
            color: #1db954;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .info-steps {
            list-style: none;
            counter-reset: step-counter;
        }

        .info-step {
            counter-increment: step-counter;
            position: relative;
            padding-left: 60px;
            margin-bottom: 25px;
            font-size: 1.05em;
            line-height: 1.6;
        }

        .info-step::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            background: linear-gradient(135deg, #1db954, #1ed760);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2em;
        }

        .info-note {
            background: rgba(30, 215, 96, 0.1);
            border-left: 4px solid #1db954;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.95em;
            color: #b3b3b3;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .top-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .item-stat {
                text-align: left;
                align-items: flex-start;
            }

            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                width: 100%;
            }

            select, input[type="text"] {
                width: 100%;
            }

            .time-range-buttons {
                flex-direction: column;
            }

            .time-range-btn {
                width: 100%;
            }
        }

        .search-result-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .search-result-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(29, 185, 84, 0.5);
            transform: translateY(-3px);
        }

        .search-result-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-result-title {
            flex: 1;
            min-width: 200px;
        }

        .search-result-name {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 5px;
            color: #fff;
        }

        .search-result-type {
            font-size: 0.9em;
            color: #1db954;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .search-result-rank {
            background: linear-gradient(135deg, #1db954, #1ed760);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 700;
            white-space: nowrap;
        }

        .search-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-mini-stat {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
        }

        .search-mini-label {
            font-size: 0.85em;
            color: #b3b3b3;
            margin-bottom: 5px;
        }

        .search-mini-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #1db954;
        }

        .listening-history {
            margin-top: 20px;
        }

        .history-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1db954;
        }

        .history-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border-left: 3px solid #1db954;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .history-date {
            color: #1db954;
            font-weight: 600;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #b3b3b3;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ Spotify Data Analyzer</h1>
            <p class="subtitle">Discover your listening history like never before</p>
            <a href="#how-to" class="help-link">üìñ How do I request my Spotify data?</a>
        </header>

        <div class="spotify-connect-section">
            <div class="spotify-connect-title">üéß Quick Connect with Spotify</div>
            <div class="spotify-connect-description">
                Get instant insights from your recent listening history
            </div>
            <div class="time-range-buttons">
                <button class="time-range-btn" onclick="connectSpotify('short_term')">Past Month</button>
                <button class="time-range-btn" onclick="connectSpotify('medium_term')">Past 6 Months</button>
                <button class="time-range-btn" onclick="connectSpotify('long_term')">Past Year</button>
            </div>
            <div class="spotify-note">
                Note: Spotify API provides limited data. For complete history, upload your full data export below.
            </div>
        </div>

        <div class="divider">‚Äî OR ‚Äî</div>

        <div class="upload-section">
            <div class="file-input-wrapper">
                <label for="fileInput" class="upload-btn">
                    üìÅ Upload Spotify Data Files
                </label>
                <input type="file" id="fileInput" accept=".json" multiple>
            </div>
            <div class="file-info" id="fileInfo"></div>
        </div>

        <div id="how-to" class="info-section">
            <h2 class="info-title">üìñ How to Request Your Spotify Data</h2>
            <ol class="info-steps">
                <li class="info-step">
                    Go to your <strong>Spotify Account Privacy Settings</strong> at 
                    <a href="https://www.spotify.com/account/privacy/" target="_blank" style="color: #1db954;">spotify.com/account/privacy</a>
                </li>
                <li class="info-step">
                    Scroll down to <strong>"Download your data"</strong> section
                </li>
                <li class="info-step">
                    Click <strong>"Request"</strong> next to "Extended streaming history"
                </li>
                <li class="info-step">
                    Wait for Spotify to email you (usually takes 5-30 days)
                </li>
                <li class="info-step">
                    Download the ZIP file from the email
                </li>
                <li class="info-step">
                    Extract the ZIP and upload the <strong>JSON files</strong> (named like "Streaming_History_Audio_...")
                </li>
            </ol>
            <div class="info-note">
                <strong>üí° Tip:</strong> The "Extended streaming history" option gives you your complete listening history, 
                while the basic option only gives you the past year. Request the extended version for the best results!
            </div>
        </div>

        <div id="results" class="hidden">
            <div class="controls-bar" style="justify-content: center; margin-bottom: 30px;">
                <button class="share-btn" onclick="generateStoryCard('overview')">
                    üì∏ Share Overview
                </button>
                <button class="share-btn" onclick="generateStoryCard('top-artist')">
                    üé§ Share Top Artist
                </button>
                <button class="share-btn" onclick="generateStoryCard('top-artists-list')">
                    üéµ Share Top 5 Artists
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Plays</div>
                    <div class="stat-value" id="totalPlays">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Time Listened</div>
                    <div class="stat-value" id="totalTime">0h 0m</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Unique Artists</div>
                    <div class="stat-value" id="uniqueArtists">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Unique Tracks</div>
                    <div class="stat-value" id="uniqueTracks">0</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('top-artists')">Top Artists</button>
                <button class="tab-btn" onclick="showTab('top-tracks')">Top Tracks</button>
                <button class="tab-btn" onclick="showTab('top-albums')">Top Albums</button>
                <button class="tab-btn" onclick="showTab('discoveries')">First Listens</button>
                <button class="tab-btn" onclick="showTab('timeline')">Listening Timeline</button>
                <button class="tab-btn" onclick="showTab('search')">üîç Search</button>
            </div>

            <div id="top-artists" class="section tab-content active">
                <h2 class="section-title">üé§ Top Artists</h2>
                
                <div id="artistExcludedTags" class="excluded-tags"></div>
                
                <div class="controls-bar">
                    <div class="control-group">
                        <span class="control-label">Sort:</span>
                        <select id="artistSort" onchange="updateArtistsList()">
                            <option value="plays-desc">Plays: High ‚Üí Low</option>
                            <option value="plays-asc">Plays: Low ‚Üí High</option>
                            <option value="time-desc">Time: High ‚Üí Low</option>
                            <option value="time-asc">Time: Low ‚Üí High</option>
                        </select>
                    </div>
                </div>
                
                <ul class="top-list" id="topArtistsList"></ul>
                <button class="load-more-btn" id="loadMoreArtists" onclick="loadMoreArtists()">Load More Artists</button>
            </div>

            <div id="top-tracks" class="section tab-content">
                <h2 class="section-title">üéµ Top Tracks</h2>
                
                <div id="trackExcludedTags" class="excluded-tags"></div>
                
                <div class="controls-bar">
                    <div class="control-group">
                        <span class="control-label">Sort:</span>
                        <select id="trackSort" onchange="updateTracksList()">
                            <option value="plays-desc">Plays: High ‚Üí Low</option>
                            <option value="plays-asc">Plays: Low ‚Üí High</option>
                            <option value="time-desc">Time: High ‚Üí Low</option>
                            <option value="time-asc">Time: Low ‚Üí High</option>
                        </select>
                    </div>
                </div>
                
                <ul class="top-list" id="topTracksList"></ul>
                <button class="load-more-btn" id="loadMoreTracks" onclick="loadMoreTracks()">Load More Tracks</button>
            </div>

            <div id="top-albums" class="section tab-content">
                <h2 class="section-title">üíø Top Albums</h2>
                
                <div id="albumExcludedTags" class="excluded-tags"></div>
                
                <div class="controls-bar">
                    <div class="control-group">
                        <span class="control-label">Sort:</span>
                        <select id="albumSort" onchange="updateAlbumsList()">
                            <option value="plays-desc">Plays: High ‚Üí Low</option>
                            <option value="plays-asc">Plays: Low ‚Üí High</option>
                            <option value="time-desc">Time: High ‚Üí Low</option>
                            <option value="time-asc">Time: Low ‚Üí High</option>
                        </select>
                    </div>
                </div>
                
                <ul class="top-list" id="topAlbumsList"></ul>
                <button class="load-more-btn" id="loadMoreAlbums" onclick="loadMoreAlbums()">Load More Albums</button>
            </div>

            <div id="discoveries" class="section tab-content">
                <h2 class="section-title">‚ú® Artist Discovery Timeline</h2>
                <div id="discoveryTimeline"></div>
                <button class="load-more-btn" id="loadMoreDiscoveries" onclick="loadMoreDiscoveries()">Load More Discoveries</button>
            </div>

            <div id="timeline" class="section tab-content">
                <h2 class="section-title">üìä Listening Over Time</h2>
                <div id="timelineChart"></div>
            </div>

            <div id="search" class="section tab-content">
                <h2 class="section-title">üîç Search Your Data</h2>
                
                <div style="margin-bottom: 30px;">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Search for artists, tracks, or albums..." 
                        style="
                            width: 100%;
                            padding: 15px 20px;
                            font-size: 1.1em;
                            background: rgba(255, 255, 255, 0.05);
                            border: 2px solid rgba(255, 255, 255, 0.1);
                            border-radius: 10px;
                            color: white;
                            outline: none;
                            transition: all 0.3s ease;
                        "
                        oninput="performSearch()"
                        onfocus="this.style.borderColor='#1db954'"
                        onblur="this.style.borderColor='rgba(255, 255, 255, 0.1)'"
                    >
                </div>

                <div id="searchResults"></div>
            </div>
        </div>
    </div>

    <!-- Story Card Modal -->
    <div id="storyModal" class="modal">
        <span class="modal-close" onclick="closeStoryModal()">&times;</span>
        <div class="modal-content">
            <canvas id="storyCanvas" style="width: 100%; border-radius: 20px;"></canvas>
            <div class="modal-actions">
                <button class="download-btn" onclick="downloadStoryCard()">
                    üíæ Download Image
                </button>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let artistStats = {};
        let trackStats = {};
        let albumStats = {};
        let topArtistsRanked = [];
        let topTracksRanked = [];
        let topAlbumsRanked = [];
        let searchTimeout = null;
        let excludedArtists = new Set();
        let currentStoryType = '';
        
        // Pagination state
        let artistsDisplayed = 50;
        let tracksDisplayed = 50;
        let albumsDisplayed = 50;
        let discoveriesDisplayed = 50;

        // Spotify API Configuration
        const SPOTIFY_CLIENT_ID = 'YOUR_CLIENT_ID_HERE'; // You'll need to replace this
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = 'user-top-read user-read-recently-played';

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        function connectSpotify(timeRange) {
            alert('To enable Spotify API connection:\n\n' +
                  '1. Create a Spotify Developer App at developer.spotify.com\n' +
                  '2. Get your Client ID\n' +
                  '3. Add ' + REDIRECT_URI + ' to your Redirect URIs\n' +
                  '4. Replace YOUR_CLIENT_ID_HERE in the code with your actual Client ID\n\n' +
                  'For now, please use the file upload method to analyze your complete listening history.');
            
            // Uncomment this when you have your Spotify credentials:
            /*
            const authUrl = `https://accounts.spotify.com/authorize?` +
                `client_id=${SPOTIFY_CLIENT_ID}&` +
                `response_type=token&` +
                `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
                `scope=${encodeURIComponent(SCOPES)}&` +
                `state=${timeRange}`;
            
            window.location.href = authUrl;
            */
        }

        // Handle Spotify OAuth callback
        if (window.location.hash) {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            const timeRange = params.get('state');
            
            if (accessToken) {
                fetchSpotifyData(accessToken, timeRange);
                // Clean up URL
                history.replaceState(null, null, window.location.pathname);
            }
        }

        async function fetchSpotifyData(accessToken, timeRange) {
            try {
                document.getElementById('fileInfo').innerHTML = '<div class="loading">Loading from Spotify...</div>';
                
                // Fetch top artists
                const artistsResponse = await fetch(
                    `https://api.spotify.com/v1/me/top/artists?time_range=${timeRange}&limit=50`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` }}
                );
                const artistsData = await artistsResponse.json();
                
                // Fetch top tracks
                const tracksResponse = await fetch(
                    `https://api.spotify.com/v1/me/top/tracks?time_range=${timeRange}&limit=50`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` }}
                );
                const tracksData = await tracksResponse.json();
                
                // Convert Spotify API data to our format
                convertSpotifyData(artistsData, tracksData, timeRange);
                
            } catch (error) {
                alert('Error fetching Spotify data: ' + error.message);
            }
        }

        function convertSpotifyData(artistsData, tracksData, timeRange) {
            // This is a simplified conversion since Spotify API doesn't provide play counts
            // We'll use popularity and ranking as proxies
            
            allData = [];
            artistStats = {};
            trackStats = {};
            
            // Process artists
            artistsData.items.forEach((artist, index) => {
                artistStats[artist.name] = {
                    plays: Math.floor(artist.popularity * (50 - index) / 10),
                    time: 0,
                    firstListen: new Date().toISOString(),
                    lastListen: new Date().toISOString(),
                    tracks: new Set(),
                    albums: new Set(),
                    playHistory: []
                };
            });
            
            // Process tracks
            tracksData.items.forEach((track, index) => {
                const artist = track.artists[0].name;
                const key = `${track.name}|||${artist}`;
                
                trackStats[key] = {
                    track: track.name,
                    artist: artist,
                    plays: Math.floor(track.popularity * (50 - index) / 10),
                    time: track.duration_ms * Math.floor(track.popularity / 10),
                    firstListen: new Date().toISOString(),
                    lastListen: new Date().toISOString(),
                    playHistory: []
                };
                
                if (artistStats[artist]) {
                    artistStats[artist].tracks.add(track.name);
                    artistStats[artist].time += track.duration_ms * Math.floor(track.popularity / 10);
                }
            });
            
            document.getElementById('fileInfo').textContent = `‚úÖ Loaded data from Spotify API (${timeRange})`;
            document.getElementById('results').classList.remove('hidden');
            
            updateAllDisplays();
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            document.getElementById('fileInfo').innerHTML = `<div class="loading">Loading ${files.length} file(s)...</div>`;
            allData = [];

            let filesProcessed = 0;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        allData = allData.concat(data);
                        filesProcessed++;

                        if (filesProcessed === files.length) {
                            processData();
                        }
                    } catch (error) {
                        alert(`Error parsing ${file.name}: ${error.message}`);
                    }
                };
                reader.readAsText(file);
            });
        }

        function processData() {
            document.getElementById('fileInfo').textContent = `‚úÖ Loaded ${allData.length.toLocaleString()} streams`;
            document.getElementById('results').classList.remove('hidden');

            // Calculate basic stats
            const totalPlays = allData.length;
            const totalMs = allData.reduce((sum, item) => sum + (item.ms_played || 0), 0);
            const totalHours = Math.floor(totalMs / 3600000);
            const totalMinutes = Math.floor((totalMs % 3600000) / 60000);

            // Unique artists and tracks
            const uniqueArtists = new Set(allData.map(item => item.master_metadata_album_artist_name).filter(Boolean));
            const uniqueTracks = new Set(allData.map(item => item.master_metadata_track_name).filter(Boolean));

            document.getElementById('totalPlays').textContent = totalPlays.toLocaleString();
            document.getElementById('totalTime').textContent = `${totalHours}h ${totalMinutes}m`;
            document.getElementById('uniqueArtists').textContent = uniqueArtists.size.toLocaleString();
            document.getElementById('uniqueTracks').textContent = uniqueTracks.size.toLocaleString();

            // Process top artists
            artistStats = {};
            allData.forEach(item => {
                const artist = item.master_metadata_album_artist_name;
                if (!artist) return;

                if (!artistStats[artist]) {
                    artistStats[artist] = {
                        plays: 0,
                        time: 0,
                        firstListen: item.ts,
                        lastListen: item.ts,
                        tracks: new Set(),
                        albums: new Set(),
                        playHistory: []
                    };
                }
                artistStats[artist].plays++;
                artistStats[artist].time += item.ms_played || 0;
                if (item.ts < artistStats[artist].firstListen) {
                    artistStats[artist].firstListen = item.ts;
                }
                if (item.ts > artistStats[artist].lastListen) {
                    artistStats[artist].lastListen = item.ts;
                }
                if (item.master_metadata_track_name) {
                    artistStats[artist].tracks.add(item.master_metadata_track_name);
                }
                if (item.master_metadata_album_album_name) {
                    artistStats[artist].albums.add(item.master_metadata_album_album_name);
                }
                artistStats[artist].playHistory.push({
                    date: item.ts,
                    track: item.master_metadata_track_name,
                    ms: item.ms_played
                });
            });

            topArtistsRanked = Object.entries(artistStats)
                .sort((a, b) => b[1].plays - a[1].plays);

            updateArtistsList();

            // Process top tracks
            trackStats = {};
            allData.forEach(item => {
                const track = item.master_metadata_track_name;
                const artist = item.master_metadata_album_artist_name;
                if (!track || !artist) return;

                const key = `${track}|||${artist}`;
                if (!trackStats[key]) {
                    trackStats[key] = {
                        track,
                        artist,
                        plays: 0,
                        time: 0,
                        firstListen: item.ts,
                        lastListen: item.ts,
                        playHistory: []
                    };
                }
                trackStats[key].plays++;
                trackStats[key].time += item.ms_played || 0;
                if (item.ts < trackStats[key].firstListen) {
                    trackStats[key].firstListen = item.ts;
                }
                if (item.ts > trackStats[key].lastListen) {
                    trackStats[key].lastListen = item.ts;
                }
                trackStats[key].playHistory.push({
                    date: item.ts,
                    ms: item.ms_played
                });
            });

            topTracksRanked = Object.values(trackStats)
                .sort((a, b) => b.plays - a.plays);

            updateTracksList();

            // Process top albums
            albumStats = {};
            allData.forEach(item => {
                const album = item.master_metadata_album_album_name;
                const artist = item.master_metadata_album_artist_name;
                if (!album || !artist) return;

                const key = `${album}|||${artist}`;
                if (!albumStats[key]) {
                    albumStats[key] = {
                        album,
                        artist,
                        plays: 0,
                        time: 0,
                        firstListen: item.ts,
                        lastListen: item.ts,
                        tracks: new Set()
                    };
                }
                albumStats[key].plays++;
                albumStats[key].time += item.ms_played || 0;
                if (item.ts < albumStats[key].firstListen) {
                    albumStats[key].firstListen = item.ts;
                }
                if (item.ts > albumStats[key].lastListen) {
                    albumStats[key].lastListen = item.ts;
                }
                if (item.master_metadata_track_name) {
                    albumStats[key].tracks.add(item.master_metadata_track_name);
                }
            });

            topAlbumsRanked = Object.values(albumStats)
                .sort((a, b) => b.plays - a.plays);

            updateAlbumsList();

            // Artist discoveries
            const discoveries = Object.entries(artistStats)
                .sort((a, b) => new Date(a[1].firstListen) - new Date(b[1].firstListen));

            displayDiscoveries(discoveries.slice(0, discoveriesDisplayed));

            // Timeline
            displayTimeline(allData);
        }

        function updateAllDisplays() {
            topArtistsRanked = Object.entries(artistStats)
                .sort((a, b) => b[1].plays - a[1].plays);
            
            topTracksRanked = Object.values(trackStats)
                .sort((a, b) => b.plays - a.plays);
            
            // Update displays
            const totalPlays = topArtistsRanked.reduce((sum, [, stats]) => sum + stats.plays, 0);
            const totalTime = topArtistsRanked.reduce((sum, [, stats]) => sum + stats.time, 0);
            const totalHours = Math.floor(totalTime / 3600000);
            const totalMinutes = Math.floor((totalTime % 3600000) / 60000);
            
            document.getElementById('totalPlays').textContent = totalPlays.toLocaleString();
            document.getElementById('totalTime').textContent = `${totalHours}h ${totalMinutes}m`;
            document.getElementById('uniqueArtists').textContent = Object.keys(artistStats).length.toLocaleString();
            document.getElementById('uniqueTracks').textContent = Object.keys(trackStats).length.toLocaleString();
            
            updateArtistsList();
            updateTracksList();
        }

        function generateStoryCard(type) {
            currentStoryType = type;
            const canvas = document.getElementById('storyCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas to Instagram Story dimensions
            canvas.width = 1080;
            canvas.height = 1920;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Create gradient background
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#1e3a8a');
            gradient.addColorStop(1, '#1e1e1e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (type === 'overview') {
                drawOverviewCard(ctx);
            } else if (type === 'top-artist') {
                drawTopArtistCard(ctx);
            } else if (type === 'top-artists-list') {
                drawTopArtistsListCard(ctx);
            }
            
            // Show modal
            document.getElementById('storyModal').classList.add('active');
        }

        function drawOverviewCard(ctx) {
            // Title
            ctx.font = 'bold 100px -apple-system, sans-serif';
            const gradient = ctx.createLinearGradient(0, 0, 1080, 0);
            gradient.addColorStop(0, '#1db954');
            gradient.addColorStop(1, '#1ed760');
            ctx.fillStyle = gradient;
            ctx.textAlign = 'center';
            ctx.fillText('My Spotify', 540, 200);
            ctx.fillText('Wrapped', 540, 320);
            
            // Stats
            const stats = [
                { label: 'TOTAL PLAYS', value: document.getElementById('totalPlays').textContent },
                { label: 'TIME LISTENED', value: document.getElementById('totalTime').textContent },
                { label: 'UNIQUE ARTISTS', value: document.getElementById('uniqueArtists').textContent }
            ];
            
            let yPos = 500;
            stats.forEach(stat => {
                // Background box
                ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                ctx.beginPath();
                ctx.roundRect(140, yPos, 800, 200, 40);
                ctx.fill();
                
                // Label
                ctx.font = '40px -apple-system, sans-serif';
                ctx.fillStyle = '#b3b3b3';
                ctx.textAlign = 'center';
                ctx.fillText(stat.label, 540, yPos + 70);
                
                // Value
                ctx.font = 'bold 100px -apple-system, sans-serif';
                ctx.fillStyle = '#1db954';
                ctx.fillText(stat.value, 540, yPos + 160);
                
                yPos += 260;
            });
            
            // Footer
            ctx.font = '40px -apple-system, sans-serif';
            ctx.fillStyle = '#1db954';
            ctx.textAlign = 'center';
            ctx.fillText('lucadigrigoli.com/spotify-analyzer', 540, 1820);
        }

        function drawTopArtistCard(ctx) {
            const filteredArtists = getSortedArtists();
            if (filteredArtists.length === 0) return;
            
            const [artistName, stats] = filteredArtists[0];
            const hours = Math.floor(stats.time / 3600000);
            const minutes = Math.floor((stats.time % 3600000) / 60000);
            
            // Title
            ctx.font = 'bold 80px -apple-system, sans-serif';
            ctx.fillStyle = '#b3b3b3';
            ctx.textAlign = 'center';
            ctx.fillText('MY TOP ARTIST', 540, 200);
            
            // Artist name (wrap if too long)
            ctx.font = 'bold 120px -apple-system, sans-serif';
            const gradient = ctx.createLinearGradient(0, 0, 1080, 0);
            gradient.addColorStop(0, '#1db954');
            gradient.addColorStop(1, '#1ed760');
            ctx.fillStyle = gradient;
            
            const words = artistName.split(' ');
            let line = '';
            let yPos = 400;
            const maxWidth = 900;
            
            words.forEach((word, index) => {
                const testLine = line + word + ' ';
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && index > 0) {
                    ctx.fillText(line.trim(), 540, yPos);
                    line = word + ' ';
                    yPos += 140;
                } else {
                    line = testLine;
                }
            });
            ctx.fillText(line.trim(), 540, yPos);
            
            // Stats boxes
            const statBoxes = [
                { label: 'PLAYS', value: stats.plays.toLocaleString() },
                { label: 'LISTENING TIME', value: `${hours}h ${minutes}m` },
                { label: 'UNIQUE TRACKS', value: stats.tracks.size.toString() }
            ];
            
            yPos = 750;
            statBoxes.forEach(stat => {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                ctx.beginPath();
                ctx.roundRect(140, yPos, 800, 180, 30);
                ctx.fill();
                
                ctx.font = '36px -apple-system, sans-serif';
                ctx.fillStyle = '#b3b3b3';
                ctx.textAlign = 'center';
                ctx.fillText(stat.label, 540, yPos + 60);
                
                ctx.font = 'bold 80px -apple-system, sans-serif';
                ctx.fillStyle = '#1db954';
                ctx.fillText(stat.value, 540, yPos + 140);
                
                yPos += 240;
            });
            
            // Footer
            ctx.font = '40px -apple-system, sans-serif';
            ctx.fillStyle = '#1db954';
            ctx.textAlign = 'center';
            ctx.fillText('lucadigrigoli.com/spotify-analyzer', 540, 1820);
        }
        function drawTopArtistsListCard(ctx) {
            // Title
            ctx.font = 'bold 100px -apple-system, sans-serif';
            const gradient = ctx.createLinearGradient(0, 0, 1080, 0);
            gradient.addColorStop(0, '#1db954');
            gradient.addColorStop(1, '#1ed760');
            ctx.fillStyle = gradient;
            ctx.textAlign = 'center';
            ctx.fillText('My Top 5', 540, 180);
            ctx.fillText('Artists', 540, 300);
            
            // Artists list - use filtered artists excluding any excluded ones
            const filteredArtists = getSortedArtists();
            let yPos = 450;
            filteredArtists.slice(0, 5).forEach(([artistName, stats], index) => {
            topArtistsRanked.slice(0, 5).forEach(([artistName, stats], index) => {
                // Background box
                ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                ctx.beginPath();
                ctx.roundRect(80, yPos, 920, 220, 30);
                ctx.fill();
                
                // Rank
                ctx.font = 'bold 100px -apple-system, sans-serif';
                ctx.fillStyle = '#1db954';
                ctx.textAlign = 'left';
                ctx.fillText(`#${index + 1}`, 140, yPos + 140);
                
                // Artist name (truncate if too long)
                ctx.font = 'bold 56px -apple-system, sans-serif';
                ctx.fillStyle = '#ffffff';
                const maxWidth = 580;
                let artistText = artistName;
                let metrics = ctx.measureText(artistText);
                
                while (metrics.width > maxWidth && artistText.length > 3) {
                    artistText = artistText.substring(0, artistText.length - 1);
                    metrics = ctx.measureText(artistText + '...');
                }
                if (metrics.width > maxWidth) {
                    artistText += '...';
                }
                
                ctx.fillText(artistText, 300, yPos + 100);
                
                // Plays
                ctx.font = '44px -apple-system, sans-serif';
                ctx.fillStyle = '#b3b3b3';
                ctx.fillText(`${stats.plays.toLocaleString()} plays`, 300, yPos + 160);
                
                yPos += 260;
            });
            
            // Footer
            ctx.font = '40px -apple-system, sans-serif';
            ctx.fillStyle = '#1db954';
            ctx.textAlign = 'center';
            ctx.fillText('lucadigrigoli.com/spotify-analyzer', 540, 1820);
        }

        function downloadStoryCard() {
            const canvas = document.getElementById('storyCanvas');
            const link = document.createElement('a');
            link.download = `spotify-${currentStoryType}-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function closeStoryModal() {
            document.getElementById('storyModal').classList.remove('active');
        }

        // Helper function for rounded rectangles
        CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
            this.beginPath();
            this.moveTo(x + radius, y);
            this.lineTo(x + width - radius, y);
            this.quadraticCurveTo(x + width, y, x + width, y + radius);
            this.lineTo(x + width, y + height - radius);
            this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            this.lineTo(x + radius, y + height);
            this.quadraticCurveTo(x, y + height, x, y + height - radius);
            this.lineTo(x, y + radius);
            this.quadraticCurveTo(x, y, x + radius, y);
            this.closePath();
        };

        function searchArtist(artistName) {
            showTab('search');
            const searchInput = document.getElementById('searchInput');
            searchInput.value = artistName;
            performSearch();
            document.getElementById('search').scrollIntoView({ behavior: 'smooth' });
        }

        function excludeArtist(artistName) {
            excludedArtists.add(artistName);
            updateArtistsList();
            updateTracksList();
            updateAlbumsList();
        }

        function removeExcludedArtist(artistName) {
            excludedArtists.delete(artistName);
            updateArtistsList();
            updateTracksList();
            updateAlbumsList();
        }

        function updateExcludedTags() {
            const tags = Array.from(excludedArtists).map(artist => `
                <div class="excluded-tag">
                    <span>${artist}</span>
                    <button onclick="removeExcludedArtist('${artist.replace(/'/g, "\\'")}')" title="Remove filter">√ó</button>
                </div>
            `).join('');

            document.getElementById('artistExcludedTags').innerHTML = tags;
            document.getElementById('trackExcludedTags').innerHTML = tags;
            document.getElementById('albumExcludedTags').innerHTML = tags;
        }

        function getSortedArtists() {
            const sortValue = document.getElementById('artistSort').value;
            const filtered = topArtistsRanked.filter(([artist]) => !excludedArtists.has(artist));
            
            switch (sortValue) {
                case 'plays-asc':
                    return filtered.sort((a, b) => a[1].plays - b[1].plays);
                case 'time-desc':
                    return filtered.sort((a, b) => b[1].time - a[1].time);
                case 'time-asc':
                    return filtered.sort((a, b) => a[1].time - b[1].time);
                default:
                    return filtered.sort((a, b) => b[1].plays - a[1].plays);
            }
        }

        function getSortedTracks() {
            const sortValue = document.getElementById('trackSort').value;
            const filtered = topTracksRanked.filter(track => !excludedArtists.has(track.artist));
            
            switch (sortValue) {
                case 'plays-asc':
                    return filtered.sort((a, b) => a.plays - b.plays);
                case 'time-desc':
                    return filtered.sort((a, b) => b.time - a.time);
                case 'time-asc':
                    return filtered.sort((a, b) => a.time - b.time);
                default:
                    return filtered.sort((a, b) => b.plays - a.plays);
            }
        }

        function getSortedAlbums() {
            const sortValue = document.getElementById('albumSort').value;
            const filtered = topAlbumsRanked.filter(album => !excludedArtists.has(album.artist));
            
            switch (sortValue) {
                case 'plays-asc':
                    return filtered.sort((a, b) => a.plays - b.plays);
                case 'time-desc':
                    return filtered.sort((a, b) => b.time - a.time);
                case 'time-asc':
                    return filtered.sort((a, b) => a.time - b.time);
                default:
                    return filtered.sort((a, b) => b.plays - a.plays);
            }
        }

        function updateArtistsList() {
            artistsDisplayed = 50;
            const sorted = getSortedArtists();
            displayTopArtists(sorted.slice(0, artistsDisplayed));
            updateExcludedTags();
            
            const loadMoreBtn = document.getElementById('loadMoreArtists');
            loadMoreBtn.style.display = sorted.length > artistsDisplayed ? 'block' : 'none';
        }

        function updateTracksList() {
            tracksDisplayed = 50;
            const sorted = getSortedTracks();
            displayTopTracks(sorted.slice(0, tracksDisplayed));
            updateExcludedTags();
            
            const loadMoreBtn = document.getElementById('loadMoreTracks');
            loadMoreBtn.style.display = sorted.length > tracksDisplayed ? 'block' : 'none';
        }

        function updateAlbumsList() {
            albumsDisplayed = 50;
            const sorted = getSortedAlbums();
            displayTopAlbums(sorted.slice(0, albumsDisplayed));
            updateExcludedTags();
            
            const loadMoreBtn = document.getElementById('loadMoreAlbums');
            loadMoreBtn.style.display = sorted.length > albumsDisplayed ? 'block' : 'none';
        }

        function loadMoreArtists() {
            artistsDisplayed += 50;
            const sorted = getSortedArtists();
            displayTopArtists(sorted.slice(0, artistsDisplayed));
            
            const loadMoreBtn = document.getElementById('loadMoreArtists');
            loadMoreBtn.style.display = sorted.length > artistsDisplayed ? 'block' : 'none';
        }

        function loadMoreTracks() {
            tracksDisplayed += 50;
            const sorted = getSortedTracks();
            displayTopTracks(sorted.slice(0, tracksDisplayed));
            
            const loadMoreBtn = document.getElementById('loadMoreTracks');
            loadMoreBtn.style.display = sorted.length > tracksDisplayed ? 'block' : 'none';
        }

        function loadMoreAlbums() {
            albumsDisplayed += 50;
            const sorted = getSortedAlbums();
            displayTopAlbums(sorted.slice(0, albumsDisplayed));
            
            const loadMoreBtn = document.getElementById('loadMoreAlbums');
            loadMoreBtn.style.display = sorted.length > albumsDisplayed ? 'block' : 'none';
        }

        function loadMoreDiscoveries() {
            discoveriesDisplayed += 50;
            const discoveries = Object.entries(artistStats)
                .filter(([artist]) => !excludedArtists.has(artist))
                .sort((a, b) => new Date(a[1].firstListen) - new Date(b[1].firstListen));
            
            displayDiscoveries(discoveries.slice(0, discoveriesDisplayed));
            
            const loadMoreBtn = document.getElementById('loadMoreDiscoveries');
            loadMoreBtn.style.display = discoveries.length > discoveriesDisplayed ? 'block' : 'none';
        }

        function performSearch() {
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('searchResults');

            if (!query) {
                resultsContainer.innerHTML = '<div class="no-results">Start typing to search artists, tracks, or albums...</div>';
                return;
            }

            resultsContainer.innerHTML = '<div class="loading">Searching...</div>';

            searchTimeout = setTimeout(() => {
                const results = [];
                const maxResults = 20;

                for (const [artist, stats] of Object.entries(artistStats)) {
                    if (results.length >= maxResults) break;
                    if (artist.toLowerCase().includes(query) && !excludedArtists.has(artist)) {
                        const rank = topArtistsRanked.findIndex(([a]) => a === artist) + 1;
                        results.push({
                            type: 'artist',
                            name: artist,
                            stats,
                            rank
                        });
                    }
                }

                if (results.length < maxResults) {
                    for (const stats of Object.values(trackStats)) {
                        if (results.length >= maxResults) break;
                        if ((stats.track.toLowerCase().includes(query) || stats.artist.toLowerCase().includes(query)) 
                            && !excludedArtists.has(stats.artist)) {
                            const rank = topTracksRanked.findIndex(t => t.track === stats.track && t.artist === stats.artist) + 1;
                            results.push({
                                type: 'track',
                                name: stats.track,
                                stats,
                                rank
                            });
                        }
                    }
                }

                if (results.length < maxResults) {
                    for (const stats of Object.values(albumStats)) {
                        if (results.length >= maxResults) break;
                        if ((stats.album.toLowerCase().includes(query) || stats.artist.toLowerCase().includes(query))
                            && !excludedArtists.has(stats.artist)) {
                            const rank = topAlbumsRanked.findIndex(a => a.album === stats.album && a.artist === stats.artist) + 1;
                            results.push({
                                type: 'album',
                                name: stats.album,
                                stats,
                                rank
                            });
                        }
                    }
                }

                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="no-results">No results found for "' + query + '"</div>';
                    return;
                }

                resultsContainer.innerHTML = results.map(result => {
                    return formatSearchResult(result);
                }).join('');
            }, 300);
        }

        function formatSearchResult(result) {
            const { type, name, stats, rank } = result;
            const hours = Math.floor(stats.time / 3600000);
            const minutes = Math.floor((stats.time % 3600000) / 60000);

            const firstListenDate = new Date(stats.firstListen).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const lastListenDate = new Date(stats.lastListen).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            let typeSpecificContent = '';

            if (type === 'artist') {
                const artistTracks = Object.values(trackStats)
                    .filter(t => t.artist === name)
                    .sort((a, b) => b.plays - a.plays)
                    .slice(0, 5);

                typeSpecificContent = `
                    <div class="search-stats-grid">
                        <div class="search-mini-stat">
                            <div class="search-mini-label">Unique Tracks</div>
                            <div class="search-mini-value">${stats.tracks.size}</div>
                        </div>
                        <div class="search-mini-stat">
                            <div class="search-mini-label">Albums</div>
                            <div class="search-mini-value">${stats.albums.size}</div>
                        </div>
                        <div class="search-mini-stat">
                            <div class="search-mini-label">Avg Play Time</div>
                            <div class="search-mini-value">${Math.round(stats.time / stats.plays / 60000)}m</div>
                        </div>
                    </div>

                    ${artistTracks.length > 0 ? `
                        <div class="listening-history">
                            <div class="history-title">Top Tracks</div>
                            ${artistTracks.map(t => `
                                <div class="history-item">
                                    ${t.track} ‚Äî ${t.plays} plays
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
            } else if (type === 'track') {
                typeSpecificContent = `
                    <div class="search-stats-grid">
                        <div class="search-mini-stat">
                            <div class="search-mini-label">Artist</div>
                            <div class="search-mini-value" style="font-size: 0.9em;">
                                <span class="artist-link" onclick="searchArtist('${stats.artist.replace(/'/g, "\\'")}')">${stats.artist}</span>
                            </div>
                        </div>
                        <div class="search-mini-stat">
                            <div class="search-mini-label">Avg Duration</div>
                            <div class="search-mini-value">${Math.round(stats.time / stats.plays / 60000)}m</div>
                        </div>
                    </div>
                `;
            } else if (type === 'album') {
                typeSpecificContent = `
                    <div class="search-stats-grid">
                        <div class="search-mini-stat">
                            <div class="search-mini-label">Artist</div>
                            <div class="search-mini-value" style="font-size: 0.9em;">
                                <span class="artist-link" onclick="searchArtist('${stats.artist.replace(/'/g, "\\'")}')">${stats.artist}</span>
                            </div>
                        </div>
                        <div class="search-mini-stat">
                            <div class="search-mini-label">Unique Tracks</div>
                            <div class="search-mini-value">${stats.tracks.size}</div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="search-result-card">
                    <div class="search-result-header">
                        <div class="search-result-title">
                            <div class="search-result-name">${name}</div>
                            <div class="search-result-type">${type}</div>
                        </div>
                        ${rank > 0 ? `<div class="search-result-rank">#${rank} Rank</div>` : ''}
                    </div>

                    <div class="search-stats-grid">
                        <div class="search-mini-stat">
                            <div class="search-mini-label">Total Plays</div>
                            <div class="search-mini-value">${stats.plays.toLocaleString()}</div>
                        </div>
                        <div class="search-mini-stat">
                            <div class="search-mini-label">Listening Time</div>
                            <div class="search-mini-value">${hours}h ${minutes}m</div>
                        </div>
                        <div class="search-mini-stat">
                            <div class="search-mini-label">First Listen</div>
                            <div class="search-mini-value" style="font-size: 0.8em;">${firstListenDate}</div>
                        </div>
                        <div class="search-mini-stat">
                            <div class="search-mini-label">Last Listen</div>
                            <div class="search-mini-value" style="font-size: 0.8em;">${lastListenDate}</div>
                        </div>
                    </div>

                    ${typeSpecificContent}
                </div>
            `;
        }

        function displayTopArtists(artists) {
            const list = document.getElementById('topArtistsList');
            list.innerHTML = artists.map(([artist, stats], index) => {
                const hours = Math.floor(stats.time / 3600000);
                const minutes = Math.floor((stats.time % 3600000) / 60000);
                return `
                    <li class="top-item">
                        <div class="rank">#${index + 1}</div>
                        <div class="item-info">
                            <div class="item-name">
                                <span class="artist-link" onclick="searchArtist('${artist.replace(/'/g, "\\'")}')">${artist}</span>
                            </div>
                            <div class="item-detail">${stats.plays.toLocaleString()} plays</div>
                        </div>
                        <div class="item-stat">
                            <div>${hours}h ${minutes}m</div>
                            <button class="exclude-btn" onclick="excludeArtist('${artist.replace(/'/g, "\\'")}')">Exclude</button>
                        </div>
                    </li>
                `;
            }).join('');
        }

        function displayTopTracks(tracks) {
            const list = document.getElementById('topTracksList');
            list.innerHTML = tracks.map((track, index) => {
                const hours = Math.floor(track.time / 3600000);
                const minutes = Math.floor((track.time % 3600000) / 60000);
                return `
                    <li class="top-item">
                        <div class="rank">#${index + 1}</div>
                        <div class="item-info">
                            <div class="item-name">${track.track}</div>
                            <div class="item-detail">
                                <span class="artist-link" onclick="searchArtist('${track.artist.replace(/'/g, "\\'")}')">${track.artist}</span>
                            </div>
                        </div>
                        <div class="item-stat">
                            <div>${track.plays} plays ‚Ä¢ ${hours}h ${minutes}m</div>
                            <button class="exclude-btn" onclick="excludeArtist('${track.artist.replace(/'/g, "\\'")}')">Exclude Artist</button>
                        </div>
                    </li>
                `;
            }).join('');
        }

        function displayTopAlbums(albums) {
            const list = document.getElementById('topAlbumsList');
            list.innerHTML = albums.map((album, index) => {
                const hours = Math.floor(album.time / 3600000);
                const minutes = Math.floor((album.time % 3600000) / 60000);
                return `
                    <li class="top-item">
                        <div class="rank">#${index + 1}</div>
                        <div class="item-info">
                            <div class="item-name">${album.album}</div>
                            <div class="item-detail">
                                <span class="artist-link" onclick="searchArtist('${album.artist.replace(/'/g, "\\'")}')">${album.artist}</span>
                            </div>
                        </div>
                        <div class="item-stat">
                            <div>${album.plays} plays ‚Ä¢ ${hours}h ${minutes}m</div>
                            <button class="exclude-btn" onclick="excludeArtist('${album.artist.replace(/'/g, "\\'")}')">Exclude Artist</button>
                        </div>
                    </li>
                `;
            }).join('');
        }

        function displayDiscoveries(discoveries) {
            const container = document.getElementById('discoveryTimeline');
            container.innerHTML = discoveries.map(([artist, stats]) => {
                const date = new Date(stats.firstListen);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const firstTrack = allData.find(item => 
                    item.master_metadata_album_artist_name === artist &&
                    item.ts === stats.firstListen
                );

                return `
                    <div class="timeline-item">
                        <div class="timeline-date">${formattedDate}</div>
                        <div class="timeline-artist">
                            <span class="artist-link" onclick="searchArtist('${artist.replace(/'/g, "\\'")}')">${artist}</span>
                        </div>
                        <div class="timeline-track">First track: ${firstTrack?.master_metadata_track_name || 'Unknown'}</div>
                    </div>
                `;
            }).join('');
            
            const loadMoreBtn = document.getElementById('loadMoreDiscoveries');
            const allDiscoveries = Object.entries(artistStats)
                .filter(([artist]) => !excludedArtists.has(artist))
                .sort((a, b) => new Date(a[1].firstListen) - new Date(b[1].firstListen));
            loadMoreBtn.style.display = allDiscoveries.length > discoveriesDisplayed ? 'block' : 'none';
        }

        function displayTimeline(data) {
            const monthlyStats = {};
            
            data.forEach(item => {
                if (excludedArtists.has(item.master_metadata_album_artist_name)) return;
                
                const date = new Date(item.ts);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyStats[monthKey]) {
                    monthlyStats[monthKey] = {
                        plays: 0,
                        time: 0
                    };
                }
                
                monthlyStats[monthKey].plays++;
                monthlyStats[monthKey].time += item.ms_played || 0;
            });

            const sortedMonths = Object.entries(monthlyStats).sort((a, b) => a[0].localeCompare(b[0]));

            const container = document.getElementById('timelineChart');
            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <div style="min-width: 600px;">
                        ${sortedMonths.map(([month, stats]) => {
                            const hours = Math.floor(stats.time / 3600000);
                            const maxPlays = Math.max(...sortedMonths.map(m => m[1].plays));
                            const height = (stats.plays / maxPlays) * 200;
                            
                            return `
                                <div style="display: inline-block; margin: 0 10px; text-align: center;">
                                    <div style="
                                        width: 40px;
                                        height: ${height}px;
                                        background: linear-gradient(180deg, #1db954, #1ed760);
                                        border-radius: 5px 5px 0 0;
                                        margin-bottom: 10px;
                                        position: relative;
                                        transition: all 0.3s ease;
                                    " 
                                    onmouseover="this.style.opacity='0.7'"
                                    onmouseout="this.style.opacity='1'"
                                    title="${stats.plays.toLocaleString()} plays, ${hours}h">
                                    </div>
                                    <div style="font-size: 0.75em; color: #b3b3b3; transform: rotate(-45deg); transform-origin: center; white-space: nowrap;">
                                        ${month}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                <div style="margin-top: 40px;">
                    ${sortedMonths.map(([month, stats]) => {
                        const date = new Date(month + '-01');
                        const hours = Math.floor(stats.time / 3600000);
                        const minutes = Math.floor((stats.time % 3600000) / 60000);
                        
                        return `
                            <div class="timeline-item">
                                <div class="timeline-date">${date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}</div>
                                <div class="timeline-track">
                                    ${stats.plays.toLocaleString()} plays ‚Ä¢ ${hours}h ${minutes}m listening time
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');

            event.target.classList.add('active');
        }
    </script>
</body>
</html>